local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local SoundService = game:GetService("SoundService")
local player = Players.LocalPlayer

-- ğŸ¯ ä¿®å¤ç‰ˆé…ç½®
local CONFIG = {
    TEXT = "BW",
    BLUR = {START = 0, END = 18, DURATION = 0.3},
    BG = {
        COLOR = Color3.fromRGB(3, 3, 8),
        TRANSPARENCY = {START = 1, END = 0.1, DURATION = 0.25}
    },
    LETTER = {
        SPACING = 80,
        INIT_SIZE = 60,
        FINAL_SIZE = 70,
        INIT_TEXT = 40,
        FINAL_TEXT = 55,
        SHADOW_OFFSET = 3
    },
    TIMING = {
        ENTRY_STAGGER = 0.15,
        ENTRY_DURATION = 0.22,
        BREATHE_SPEED = 1.5,
        DISPLAY_TIME = 1.0,
        EXIT_DURATION = 0.35
    },
    SOUND = {
        -- ç»“æŸéŸ³æ•ˆé…ç½®
        END_SOUND_ID = "rbxassetid://9129543124",  -- é«˜è´¨é‡å®ŒæˆéŸ³æ•ˆ
        VOLUME = 0.5,
        PITCH = 1.0,
        PLAY_ON_EXIT = true
    },
    COLORS = {
        WHITE = Color3.fromRGB(255, 255, 255),
        WHITE_98 = Color3.fromRGB(250, 250, 250),
        WHITE_95 = Color3.fromRGB(242, 242, 242),
        GRAY_90 = Color3.fromRGB(230, 230, 230),
        GRAY_80 = Color3.fromRGB(204, 204, 204),
        GRAY_60 = Color3.fromRGB(153, 153, 153),
        GRAY_40 = Color3.fromRGB(102, 102, 102),
        GRAY_20 = Color3.fromRGB(51, 51, 51),
        BLACK_10 = Color3.fromRGB(26, 26, 26),
        BLACK_05 = Color3.fromRGB(13, 13, 13),
        SHADOW = Color3.fromRGB(0, 0, 0)
    }
}

-- âš¡ ä¿®å¤çŠ¶æ€ç®¡ç†
local State = {
    active = false,
    cleanupQueue = {}
}

local function safeDestroy(obj)
    if obj and obj.Parent then
        obj:Destroy()
    end
end

local function cleanupAll()
    for _, obj in ipairs(State.cleanupQueue) do
        if type(obj) == "function" then
            obj()  -- å¦‚æœæ˜¯å‡½æ•°ï¼Œæ‰§è¡Œæ¸…ç†
        else
            safeDestroy(obj)
        end
    end
    State.cleanupQueue = {}
    State.active = false
end

-- ğŸ”Š éŸ³æ•ˆç³»ç»Ÿ
local function createSoundEffect()
    local sound = Instance.new("Sound")
    sound.SoundId = CONFIG.SOUND.END_SOUND_ID
    sound.Volume = CONFIG.SOUND.VOLUME
    sound.Pitch = CONFIG.SOUND.PITCH
    sound.Name = "LoaderCompleteSound"
    
    -- æ·»åŠ åˆ°æ¸…ç†é˜Ÿåˆ—
    table.insert(State.cleanupQueue, sound)
    
    return sound
end

local function playExitSound()
    if not CONFIG.SOUND.PLAY_ON_EXIT then return end
    
    local sound = createSoundEffect()
    sound.Parent = SoundService
    
    -- æ’­æ”¾éŸ³æ•ˆ
    sound:Play()
    
    -- éŸ³æ•ˆæ’­æ”¾å®Œæˆåè‡ªåŠ¨é”€æ¯
    sound.Ended:Connect(function()
        safeDestroy(sound)
    end)
    
    -- å¦‚æœéŸ³æ•ˆå¡ä½ï¼Œ5ç§’åå¼ºåˆ¶é”€æ¯
    task.delay(5, function()
        safeDestroy(sound)
    end)
end

-- âœ¨ é¢„è®¾åŠ¨ç”»æ›²çº¿
local TWEEN = {
    SNAP = TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    SMOOTH = TweenInfo.new(0.25, Enum.EasingStyle.Cubic, Enum.EasingDirection.Out),
    BOUNCE = TweenInfo.new(0.2, Enum.EasingStyle.Back, Enum.EasingDirection.Out, 0, false, 0),
    FADE = TweenInfo.new(0.3, Enum.EasingStyle.Cubic, Enum.EasingDirection.In)
}

-- ğŸ¨ ä¿®å¤æ–‡å­—æ¸²æŸ“ç³»ç»Ÿ
local function createPremiumText(char, index, parent)
    local totalWidth = (#CONFIG.TEXT - 1) * CONFIG.LETTER.SPACING
    local startX = -totalWidth / 2
    local posX = startX + (index - 1) * CONFIG.LETTER.SPACING
    
    -- ä¸»æ–‡å­—
    local mainLabel = Instance.new("TextLabel")
    mainLabel.Text = char
    mainLabel.Font = Enum.Font.GothamBlack
    mainLabel.TextColor3 = CONFIG.COLORS.WHITE
    mainLabel.TextSize = CONFIG.LETTER.INIT_TEXT
    mainLabel.Size = UDim2.new(0, CONFIG.LETTER.INIT_SIZE, 0, CONFIG.LETTER.INIT_SIZE)
    mainLabel.AnchorPoint = Vector2.new(0.5, 0.5)
    mainLabel.Position = UDim2.new(0.5, posX, 0.5, 40)
    mainLabel.BackgroundTransparency = 1
    mainLabel.TextTransparency = 1
    mainLabel.ZIndex = 4
    mainLabel.TextXAlignment = Enum.TextXAlignment.Center
    mainLabel.TextYAlignment = Enum.TextYAlignment.Center
    mainLabel.Parent = parent
    
    -- ä¿®å¤é˜´å½±å±‚
    local shadowLayer = Instance.new("TextLabel")
    shadowLayer.Text = char
    shadowLayer.Font = Enum.Font.GothamBlack
    shadowLayer.TextColor3 = CONFIG.COLORS.SHADOW
    shadowLayer.TextSize = CONFIG.LETTER.INIT_TEXT + 4
    shadowLayer.Size = mainLabel.Size
    shadowLayer.AnchorPoint = mainLabel.AnchorPoint
    shadowLayer.Position = mainLabel.Position + UDim2.new(0, CONFIG.LETTER.SHADOW_OFFSET, 0, CONFIG.LETTER.SHADOW_OFFSET)
    shadowLayer.BackgroundTransparency = 1
    shadowLayer.TextTransparency = 0.8
    shadowLayer.ZIndex = 3
    shadowLayer.TextXAlignment = Enum.TextXAlignment.Center
    shadowLayer.TextYAlignment = Enum.TextYAlignment.Center
    shadowLayer.Parent = parent
    
    -- ä¿®å¤å…‰æ™•å±‚
    local glowLayer = Instance.new("TextLabel")
    glowLayer.Text = char
    glowLayer.Font = Enum.Font.GothamBlack
    glowLayer.TextColor3 = CONFIG.COLORS.WHITE_98
    glowLayer.TextSize = CONFIG.LETTER.INIT_TEXT + 8
    glowLayer.Size = mainLabel.Size + UDim2.new(0, 16, 0, 16)
    glowLayer.AnchorPoint = mainLabel.AnchorPoint
    glowLayer.Position = mainLabel.Position
    glowLayer.BackgroundTransparency = 1
    glowLayer.TextTransparency = 0.95
    glowLayer.ZIndex = 2
    glowLayer.TextXAlignment = Enum.TextXAlignment.Center
    glowLayer.TextYAlignment = Enum.TextYAlignment.Center
    glowLayer.Parent = parent
    
    -- ä¿®å¤æ¸å˜æ•ˆæœ
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0.0, CONFIG.COLORS.WHITE),
        ColorSequenceKeypoint.new(0.1, CONFIG.COLORS.WHITE_95),
        ColorSequenceKeypoint.new(0.2, CONFIG.COLORS.GRAY_90),
        ColorSequenceKeypoint.new(0.3, CONFIG.COLORS.GRAY_80),
        ColorSequenceKeypoint.new(0.4, CONFIG.COLORS.GRAY_60),
        ColorSequenceKeypoint.new(0.5, CONFIG.COLORS.GRAY_40),
        ColorSequenceKeypoint.new(0.6, CONFIG.COLORS.GRAY_20),
        ColorSequenceKeypoint.new(0.7, CONFIG.COLORS.BLACK_10),
        ColorSequenceKeypoint.new(0.8, CONFIG.COLORS.BLACK_05),
        ColorSequenceKeypoint.new(0.9, CONFIG.COLORS.SHADOW),
        ColorSequenceKeypoint.new(1.0, CONFIG.COLORS.SHADOW)
    })
    gradient.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 0),
        NumberSequenceKeypoint.new(0.8, 0),
        NumberSequenceKeypoint.new(1, 0.1)
    })
    gradient.Rotation = 92
    gradient.Parent = mainLabel
    
    -- æ·»åŠ åˆ°æ¸…ç†é˜Ÿåˆ—
    table.insert(State.cleanupQueue, function()
        mainLabel:Destroy()
        shadowLayer:Destroy()
        glowLayer:Destroy()
    end)
    
    return {
        main = mainLabel,
        shadow = shadowLayer,
        glow = glowLayer,
        initialPos = UDim2.new(0.5, posX, 0.5, 0)
    }
end

-- ğŸš€ ä¿®å¤å…¥åœºåŠ¨ç”»
local function playPremiumEntry(letters)
    for i, letter in ipairs(letters) do
        local delay = (i - 1) * CONFIG.TIMING.ENTRY_STAGGER
        
        task.delay(delay, function()
            if not letter.main or not letter.main.Parent then return end
            
            -- ä¸»æ–‡å­—å¼¹è·³å…¥åœº
            local mainTween = TweenService:Create(letter.main, TWEEN.BOUNCE, {
                TextTransparency = 0,
                TextSize = CONFIG.LETTER.FINAL_TEXT,
                Size = UDim2.new(0, CONFIG.LETTER.FINAL_SIZE, 0, CONFIG.LETTER.FINAL_SIZE),
                Position = UDim2.new(0.5, letter.initialPos.X.Offset, 0.5, -8)
            })
            mainTween:Play()
            
            -- é˜´å½±åŒæ­¥åŠ¨ç”»
            local shadowTween = TweenService:Create(letter.shadow, TWEEN.BOUNCE, {
                TextTransparency = 0.5,
                TextSize = CONFIG.LETTER.FINAL_TEXT + 4,
                Size = UDim2.new(0, CONFIG.LETTER.FINAL_SIZE, 0, CONFIG.LETTER.FINAL_SIZE),
                Position = UDim2.new(0.5, letter.initialPos.X.Offset + 2, 0.5, -6)
            })
            shadowTween:Play()
            
            -- å…‰æ™•å±‚åŠ¨ç”»
            local glowTween = TweenService:Create(letter.glow, TWEEN.SMOOTH, {
                TextTransparency = 0.85,
                TextSize = CONFIG.LETTER.FINAL_TEXT + 12,
                Size = UDim2.new(0, CONFIG.LETTER.FINAL_SIZE + 20, 0, CONFIG.LETTER.FINAL_SIZE + 20)
            })
            glowTween:Play()
            
            -- å¾®è°ƒè‡³æœ€ç»ˆä½ç½®
            task.delay(CONFIG.TIMING.ENTRY_DURATION, function()
                if letter.main and letter.main.Parent then
                    TweenService:Create(letter.main, TWEEN.SNAP, {
                        Position = letter.initialPos
                    }):Play()
                    
                    TweenService:Create(letter.shadow, TWEEN.SNAP, {
                        Position = letter.initialPos + UDim2.new(0, 2, 0, 2)
                    }):Play()
                end
            end)
        end)
    end
end

-- ğŸ’« ä¿®å¤å‘¼å¸æ•ˆæœ
local function createBreatheEffect(letters)
    local time = 0
    local heartbeat
    
    heartbeat = RunService.Heartbeat:Connect(function(delta)
        time = time + delta * CONFIG.TIMING.BREATHE_SPEED
        
        local breathe1 = 0.98 + math.sin(time) * 0.02
        local breathe2 = 0.95 + math.sin(time * 1.3) * 0.03
        local pulse = 1 + math.sin(time * 0.8) * 0.08
        
        for _, letter in ipairs(letters) do
            if letter.main and letter.main.Parent then
                -- ä¸»æ–‡å­—å‘¼å¸
                letter.main.TextTransparency = 1 - breathe1
                letter.main.TextSize = CONFIG.LETTER.FINAL_TEXT * pulse
                
                -- é˜´å½±å‘¼å¸
                letter.shadow.TextTransparency = 0.4 + (1 - breathe2) * 0.3
                
                -- å…‰æ™•è„‰åŠ¨
                letter.glow.TextTransparency = 0.8 + math.sin(time * 0.5) * 0.15
                letter.glow.TextSize = (CONFIG.LETTER.FINAL_TEXT + 12) * pulse
            end
        end
    end)
    
    table.insert(State.cleanupQueue, function()
        if heartbeat then
            heartbeat:Disconnect()
        end
    end)
    
    return heartbeat
end

-- ğŸŒŒ ä¿®å¤é€€å‡ºåºåˆ—ï¼ˆå¸¦éŸ³æ•ˆï¼‰
local function playPremiumExit(letters, blur, bg)
    -- æ’­æ”¾ç»“æŸéŸ³æ•ˆ
    playExitSound()
    
    -- å­—æ¯åˆ†é˜¶æ®µé€€å‡º
    for i, letter in ipairs(letters) do
        local exitDelay = (i - 1) * 0.05
        local upDistance = -60 - (i * 5)
        
        task.delay(exitDelay, function()
            if letter.main and letter.main.Parent then
                -- ä¸»æ–‡å­—å‘ä¸Šæ·¡å‡º
                TweenService:Create(letter.main, TWEEN.FADE, {
                    TextTransparency = 1,
                    Position = UDim2.new(0.5, letter.initialPos.X.Offset, 0.5, upDistance),
                    TextSize = 30,
                    Rotation = (i % 2 == 0) and 15 or -15
                }):Play()
                
                -- é˜´å½±æ·¡å‡º
                TweenService:Create(letter.shadow, TWEEN.FADE, {
                    TextTransparency = 1,
                    Position = UDim2.new(0.5, letter.initialPos.X.Offset + 2, 0.5, upDistance + 2)
                }):Play()
                
                -- å…‰æ™•æ¶ˆæ•£
                TweenService:Create(letter.glow, TWEEN.FADE, {
                    TextTransparency = 1,
                    TextSize = 20,
                    Size = UDim2.new(0, 30, 0, 30)
                }):Play()
            end
        end)
    end
    
    -- èƒŒæ™¯æ•ˆæœæ·¡å‡º
    if bg then
        TweenService:Create(bg, TWEEN.FADE, {
            BackgroundTransparency = 1
        }):Play()
    end
    
    if blur then
        TweenService:Create(blur, TWEEN.FADE, {
            Size = 0
        }):Play()
    end
end

-- ğŸ”— åŠ è½½å¤–éƒ¨è„šæœ¬ï¼ˆåªåŠ è½½ç¬¬äºŒä¸ªè„šæœ¬ï¼‰
local function loadExternalScript()
    local success, result = pcall(function()
        loadstring(game:HttpGet('https://raw.githubusercontent.com/tfcygvunbind/Apple/main/å“‡ï¼'))()
    end)
    
    if not success then
        warn("è„šæœ¬åŠ è½½å¤±è´¥:", result)
    end
end

-- âš¡ ä¿®å¤ä¸»æ‰§è¡Œæµç¨‹
local function initLoader()
    if State.active then return end
    State.active = true
    
    -- åˆ›å»ºæ ¸å¿ƒUI
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PremiumLoader"
    screenGui.ResetOnSpawn = false
    screenGui.IgnoreGuiInset = true
    screenGui.DisplayOrder = 999
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundTransparency = 1
    frame.Parent = screenGui
    
    -- ç¡®ä¿PlayerGuiå­˜åœ¨
    local playerGui = player:WaitForChild("PlayerGui")
    screenGui.Parent = playerGui
    
    -- æ·±è‰²èƒŒæ™¯
    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(1, 0, 1, 0)
    bg.BackgroundColor3 = CONFIG.BG.COLOR
    bg.BackgroundTransparency = CONFIG.BG.TRANSPARENCY.START
    bg.ZIndex = 0
    bg.Parent = frame
    
    TweenService:Create(bg, TWEEN.SMOOTH, {
        BackgroundTransparency = CONFIG.BG.TRANSPARENCY.END
    }):Play()
    
    -- èƒŒæ™¯æ¨¡ç³Š
    local blur = Instance.new("BlurEffect")
    blur.Size = CONFIG.BLUR.START
    blur.Parent = Lighting
    
    TweenService:Create(blur, TWEEN.SMOOTH, {
        Size = CONFIG.BLUR.END
    }):Play()
    
    -- åˆ›å»ºBWä¸¤ä¸ªå­—æ¯
    local letters = {}
    for i = 1, #CONFIG.TEXT do
        local letter = createPremiumText(CONFIG.TEXT:sub(i, i), i, frame)
        table.insert(letters, letter)
    end
    
    -- æ·»åŠ åˆ°æ¸…ç†é˜Ÿåˆ—
    table.insert(State.cleanupQueue, screenGui)
    table.insert(State.cleanupQueue, blur)
    table.insert(State.cleanupQueue, bg)
    
    -- ğŸ¬ åŠ¨ç”»åºåˆ—
    task.delay(0.05, function()
        -- ç¬¬ä¸€é˜¶æ®µï¼šå­—æ¯å…¥åœº
        playPremiumEntry(letters)
        
        -- ç¬¬äºŒé˜¶æ®µï¼šå¯åŠ¨å‘¼å¸æ•ˆæœ
        task.delay(CONFIG.TIMING.ENTRY_DURATION * 3, function()
            createBreatheEffect(letters)
        end)
        
        -- ç¬¬ä¸‰é˜¶æ®µï¼šé€€å‡ºå¹¶åŠ è½½å¤–éƒ¨è„šæœ¬
        task.delay(CONFIG.TIMING.DISPLAY_TIME, function()
            playPremiumExit(letters, blur, bg)
            
            task.delay(CONFIG.TIMING.EXIT_DURATION + 0.15, function()
                cleanupAll()
                -- åŠ è½½å¤–éƒ¨è„šæœ¬
                loadExternalScript()
            end)
        end)
    end)
    
    return true
end

-- ğŸ›¡ï¸ å®‰å…¨å¯åŠ¨
task.spawn(function()
    local success, err = pcall(initLoader)
    if not success then
        warn("åŠ è½½åŠ¨ç”»å¤±è´¥:", err)
        cleanupAll()
        -- ç›´æ¥åŠ è½½å¤–éƒ¨è„šæœ¬
        loadExternalScript()
    end
end)
